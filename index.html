<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>PDFStamp - Pro Business Tool V16</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box}body{font-family:Sarabun,'TH Sarabun PSK',sans-serif;margin:0;padding:0;height:100vh;display:flex;flex-direction:column;overflow:hidden;background:#333}.header-bar{height:50px;background:#222;color:#fff;display:flex;align-items:center;justify-content:center;gap:20px;font-size:1.5rem;font-weight:700;border-bottom:1px solid #444;flex-shrink:0;z-index:20;position:relative}.header-bar span{color:#007bff}.project-btn-group{position:absolute;right:20px;display:flex;gap:10px}.btn-proj{font-size:.8rem;padding:5px 10px;border-radius:4px;cursor:pointer;border:1px solid #555;background:#444;color:#fff}.btn-proj:hover{background:#666}.main-container{display:flex;flex-grow:1;overflow:hidden;height:calc(100vh - 50px)}.sidebar{width:320px;background:#2c3e50;color:#fff;display:flex;flex-direction:column;border-right:1px solid #444;padding:15px;overflow-y:auto;flex-shrink:0;z-index:2}.sidebar h2{margin-top:0;font-size:1.1rem;border-bottom:1px solid #4a6278;padding-bottom:10px;color:#ecf0f1}.upload-box{background:#34495e;padding:10px;border-radius:6px;text-align:center;margin-bottom:15px;border:2px dashed #7f8c8d;cursor:pointer;transition:.2s}.upload-box:hover{background:#3d566e;border-color:#bdc3c7}.upload-box p{margin:5px 0 0;font-size:.8rem;color:#ecf0f1}.preset-box{margin-top:20px;border-top:1px solid #4a6278;padding-top:15px}.preset-input-group{display:flex;gap:5px;margin-bottom:10px}.preset-input{flex-grow:1;padding:5px;border-radius:4px;border:none}.preset-list{display:flex;flex-direction:column;gap:5px}.preset-item{background:#34495e;padding:8px;border-radius:4px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:.2s}.preset-item:hover{background:#3d566e;border-left:3px solid #007bff}.preset-del{color:#e74c3c;font-weight:700;cursor:pointer;padding:0 5px}.file-list{display:flex;flex-direction:column;gap:10px}.file-item{background:#fff;color:#333;border-radius:5px;padding:10px;border-left:5px solid transparent}.file-header{display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:.85rem;margin-bottom:8px}.file-remove{color:red;cursor:pointer;font-size:1.2rem;padding:0 5px}.btn-all{background:#17a2b8;color:#fff;border:none;border-radius:3px;padding:2px 6px;font-size:.7rem;cursor:pointer;margin-left:5px}.page-selector{display:flex;flex-wrap:wrap;gap:4px}.page-btn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:.8rem;border:1px solid #ccc;background:#f8f9fa;cursor:pointer;border-radius:3px;color:#ccc}.page-btn.selected{background:#28a745;color:#fff;border-color:#28a745;font-weight:700}.workspace{flex-grow:1;background:#555;display:flex;flex-direction:column;position:relative;height:100%}.toolbar{background:#fff;padding:5px 15px;display:flex;gap:10px;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,.2);z-index:10;height:60px;flex-shrink:0;overflow-x:auto}.canvas-scroll-area{flex-grow:1;overflow:auto;padding:30px;background:#666;display:flex;flex-direction:column;align-items:center}#scalableContent{display:flex;flex-direction:column;gap:30px;transform-origin:top center;transition:transform .1s ease-out}.canvas-wrapper-card{background:#fff;box-shadow:0 5px 15px rgba(0,0,0,.3);position:relative}.page-label{position:absolute;top:-28px;left:0;color:#fff;font-size:.9rem;background:#444;padding:4px 10px;border-radius:4px 4px 0 0;display:flex;align-items:center;gap:5px;white-space:nowrap}.page-label span{font-weight:700;color:#4db8ff}input[type=file]{display:none}.btn{padding:6px 10px;border:none;border-radius:4px;cursor:pointer;font-size:.85rem;font-weight:700;transition:.2s;white-space:nowrap;display:flex;align-items:center;gap:5px}.btn-blue{background:#007bff;color:#fff}.btn-blue:hover{background:#0056b3}.btn-green{background:#27ae60;color:#fff}.btn-green:hover{background:#219150}.btn-red{background:#e74c3c;color:#fff}.btn-red:hover{background:#c0392b}.btn-orange{background:#e67e22;color:#fff}.btn-orange:hover{background:#d35400}.btn-purple{background:#6f42c1;color:#fff}.btn-purple:hover{background:#59359a}.btn-dark{background:#343a40;color:#fff}.btn-dark:hover{background:#23272b}.btn.active-tool{box-shadow:inset 0 0 0 2px #222;transform:scale(.95);background-color:#ffd700;color:#000}.control-group{display:flex;align-items:center;gap:5px;padding:0 10px;border-left:1px solid #ddd}.download-group{margin-left:auto;border-left:1px solid #ddd;padding-left:10px;display:flex;gap:5px}.format-select{padding:6px;border:1px solid #ccc;border-radius:4px;font-weight:700;color:#333;cursor:pointer}.slot-select{padding:6px;border:2px solid #e67e22;border-radius:4px;font-weight:700;color:#e67e22;cursor:pointer;background:#fff5eb}.stamp-gallery-container{display:flex;align-items:center;gap:8px;overflow-x:auto;max-width:150px;height:100%;padding:0 5px}.stamp-thumb{height:40px;width:auto;object-fit:contain;border:2px solid transparent;cursor:pointer;background:#fff;padding:2px;border-radius:4px;box-shadow:0 2px 4px rgba(0,0,0,.1)}#loadingOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);color:#fff;z-index:2000;justify-content:center;align-items:center;flex-direction:column}.empty-state{color:#ccc;text-align:center;margin-top:50px;font-size:1.2rem;width:100%}input[type=color]{width:30px;height:30px;border:none;padding:0;background:none;cursor:pointer}input[type=range]{width:80px}#customContextMenu{display:none;position:fixed;z-index:3000;background:#fff;border:1px solid #bbb;border-radius:4px;box-shadow:2px 2px 10px rgba(0,0,0,.2);min-width:150px}.context-menu-item{padding:10px 15px;cursor:pointer;font-size:.9rem;color:#333;display:flex;align-items:center;gap:8px}.context-menu-item:hover{background:#f0f7ff;color:#007bff}.cursor-pen .upper-canvas{cursor:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewport="0 0 24 24" style="fill:black;stroke:white;stroke-width:1px;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>') 0 24,auto!important}.cursor-highlight .upper-canvas{cursor:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewport="0 0 24 24" style="fill:orange;stroke:black;stroke-width:1px;"><path d="M15.25 2.25l-2.5 2.5 5 5 2.5-2.5-5-5zM2.25 15.25l5 5 10.5-10.5-5-5-10.5 10.5z"/></svg>') 0 24,auto!important}.cursor-text .upper-canvas{cursor:text!important}.cursor-crosshair .upper-canvas{cursor:crosshair!important}.color-dot{width:20px;height:20px;border-radius:50%;cursor:pointer;border:1px solid #ccc}
</style>
</head>
<body>
<div id="customContextMenu"><div class="context-menu-item" onclick="addTextToPresetFromMenu()">‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢</div></div>
<div id="loadingOverlay"><h2>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</h2><p id="loadingText">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p></div>
<div class="header-bar">PDF<span>Stamp</span><div class="project-btn-group"><button class="btn-proj" onclick="saveProject()">üíæ Save Project</button><label class="btn-proj" for="projectLoad">üìÇ Open Project</label><input type="file" id="projectLoad" accept=".pdfstamp" onchange="loadProject(this)"></div></div>
<div class="main-container">
<div class="sidebar"><h2>üìÇ 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h2><label for="docUpload" class="upload-box"><span style="font-size:1.5rem">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span><p>(PDF ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)</p></label><input type="file" id="docUpload" accept="image/*,application/pdf" multiple><div id="fileList" class="file-list"></div><div class="preset-box"><h2>üìù ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢</h2><div class="preset-input-group"><input type="text" id="newPresetInput" class="preset-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..."><button class="btn btn-green" onclick="addPreset()">+</button></div><div id="presetList" class="preset-list"></div></div></div>
<div class="workspace">
<div class="toolbar">
<div class="control-group"><button id="tool-select" class="btn btn-dark active-tool" onclick="setTool('select')">üëÜ</button><button id="tool-pen" class="btn btn-dark" onclick="setTool('pen')">‚úèÔ∏è</button><button id="tool-highlight" class="btn btn-dark" onclick="setTool('highlight')">üñçÔ∏è</button><button id="tool-text" class="btn btn-dark" onclick="setTool('text')">üÖ∞Ô∏è</button></div>
<div class="control-group"><div class="color-dot" style="background:#000" onclick="setPaletteColor('#000000')"></div><div class="color-dot" style="background:#00f" onclick="setPaletteColor('#0000ff')"></div><div class="color-dot" style="background:red" onclick="setPaletteColor('#ff0000')"></div><div class="color-dot" style="background:#ff0" onclick="setPaletteColor('#FFFF00')"></div><input type="color" id="colorPicker" value="#000000" onchange="updateDrawSettings()"><input type="range" id="sizeSlider" min="1" max="50" value="3" oninput="updateDrawSettings()"></div>
<label for="stampUpload" class="btn btn-blue">¬©Ô∏è ‡∏ï‡∏£‡∏≤</label><input type="file" id="stampUpload" accept="image/png,image/jpeg" multiple><div class="stamp-gallery-container" id="stampGallery"></div>
<div class="control-group"><select id="slotSelect" class="slot-select" onchange="loadFromSlot(this.value)"><option value="1">Slot 1</option><option value="2">Slot 2</option><option value="3">Slot 3</option><option value="4">Slot 4</option><option value="5">Slot 5</option></select><button class="btn btn-orange" onclick="saveToCurrentSlot()">üíæ</button><button class="btn btn-purple" onclick="loadFromCurrentSlot()">üìÇ</button></div>
<div class="control-group"><button class="btn btn-red" onclick="clearAllSignatures()">‚ùå</button></div>
<div class="control-group"><button class="btn btn-dark" onclick="adjustZoom(-0.1)">üîç-</button><span id="zoomDisplay" style="width:35px">100%</span><button class="btn btn-dark" onclick="adjustZoom(0.1)">üîç+</button></div>
<div class="download-group"><select id="dlFormat" class="format-select"><option value="pdf">PDF</option><option value="jpg">JPG</option></select><button class="btn btn-green" onclick="downloadAllFiles()">‚¨áÔ∏è</button></div>
</div>
<div class="canvas-scroll-area"><div id="scalableContent"><div class="empty-state">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div></div></div>
</div>
</div>
<script>
let projectFiles=[],activeCanvases=[],masterStampsJSON=null,currentZoom=1,currentTool='select',drawColor='#000000',drawWidth=3,isDrawingLine=!1,lineToDraw=null,pageHistory={},textPresets=[],activeTextForMenu=null;pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
window.addEventListener('DOMContentLoaded',()=>{const l=localStorage.getItem('pdfstamp_last_slot')||"1";document.getElementById('slotSelect').value=l;loadFromSlot(l,!0);const s=localStorage.getItem('pdfstamp_presets');if(s)textPresets=JSON.parse(s);renderPresets();document.getElementById('newPresetInput').addEventListener('keydown',e=>{if(e.key==='Enter')addPreset()});window.addEventListener('click',()=>document.getElementById('customContextMenu').style.display='none')});
function setTool(t){currentTool=t;if(t==='highlight'&&drawColor==='#000000')setPaletteColor('#FFFF00');document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active-tool'));const el=document.getElementById(`tool-${t}`);if(el)el.classList.add('active-tool');activeCanvases.forEach(i=>{const w=i.canvas.wrapperEl;w.classList.remove('cursor-pen','cursor-highlight','cursor-text','cursor-crosshair');if(t==='pen')w.classList.add('cursor-pen');else if(t==='highlight')w.classList.add('cursor-highlight');else if(t==='text')w.classList.add('cursor-text');applyToolSettings(i.canvas)})}
function setPaletteColor(c){document.getElementById('colorPicker').value=c;updateDrawSettings()}
function updateDrawSettings(){drawColor=document.getElementById('colorPicker').value;drawWidth=parseInt(document.getElementById('sizeSlider').value,10);activeCanvases.forEach(i=>{const o=i.canvas.getActiveObject();if(o){saveHistory(i.canvas);if(o.type==='i-text')o.set({fill:drawColor});else if(o.type==='path')o.set({stroke:drawColor,strokeWidth:drawWidth});else if(o.type==='line'){const h=o.opacity<1;o.set({stroke:drawColor,strokeWidth:h?drawWidth*6:drawWidth})}i.canvas.renderAll()}if(i.canvas.freeDrawingBrush){i.canvas.freeDrawingBrush.color=drawColor;i.canvas.freeDrawingBrush.width=drawWidth}})}
function applyToolSettings(c){c.isDrawingMode=!1;c.selection=!0;c.skipTargetFind=!1;c.defaultCursor='default';c.off('mouse:down',handleMouseDown);c.off('mouse:move',handleMouseMove);c.off('mouse:up',handleMouseUp);if(currentTool==='pen'){c.isDrawingMode=!0;c.freeDrawingBrush=new fabric.PencilBrush(c);c.freeDrawingBrush.color=drawColor;c.freeDrawingBrush.width=drawWidth}else if(currentTool==='highlight'||currentTool==='text'){c.selection=!1;c.skipTargetFind=!0;c.on('mouse:down',handleMouseDown);c.on('mouse:move',handleMouseMove);c.on('mouse:up',handleMouseUp)}}
function handleMouseDown(o){const c=this;const p=c.getPointer(o.e);if(currentTool==='text'){saveHistory(c);const t=new fabric.IText('‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°',{left:p.x,top:p.y,fontFamily:'TH Sarabun PSK, Sarabun, sans-serif',fill:'#0000ff',fontSize:16,cursorColor:'blue'});c.add(t);c.setActiveObject(t);t.enterEditing();setTool('select');return}if(currentTool==='highlight'){isDrawingLine=!0;saveHistory(c);const w=drawWidth*6;lineToDraw=new fabric.Line([p.x,p.y,p.x,p.y],{strokeWidth:w,fill:drawColor,stroke:drawColor,opacity:.35,selectable:!0,strokeLineCap:'butt',evented:!0,originX:'center',originY:'center'});c.add(lineToDraw)}}
function handleMouseMove(o){if(!isDrawingLine)return;const c=this;const p=c.getPointer(o.e);lineToDraw.set({x2:p.x,y2:p.y});c.renderAll()}
function handleMouseUp(o){if(isDrawingLine){isDrawingLine=!1;lineToDraw.setCoords()}}
function renderPresets(){const l=document.getElementById('presetList');l.innerHTML='';textPresets.forEach((t,i)=>{const d=document.createElement('div');d.className='preset-item';d.innerHTML=`<span onclick="applyPreset('${t}')">${t}</span> <span class="preset-del" onclick="delPreset(${i})">&times;</span>`;l.appendChild(d)})}
function addPreset(t=null){if(!t){const i=document.getElementById('newPresetInput');t=i.value.trim();if(t)i.value=''}if(t&&!textPresets.includes(t)){textPresets.push(t);localStorage.setItem('pdfstamp_presets',JSON.stringify(textPresets));renderPresets()}}
function delPreset(i){textPresets.splice(i,1);localStorage.setItem('pdfstamp_presets',JSON.stringify(textPresets));renderPresets()}
function applyPreset(t){if(activeCanvases.length===0)return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô');const c=activeCanvases[0].canvas;saveHistory(c);const o=new fabric.IText(t,{left:c.width-20,top:c.height-20,fontFamily:'TH Sarabun PSK, Sarabun, sans-serif',fill:'#0000ff',fontSize:16,originX:'right',originY:'bottom',cursorColor:'blue'});c.add(o);c.setActiveObject(o);c.renderAll();setTool('select')}
function showContextMenu(x,y){const m=document.getElementById('customContextMenu');m.style.display='block';m.style.left=x+'px';m.style.top=y+'px'}
function addTextToPresetFromMenu(){if(activeTextForMenu&&activeTextForMenu.text)addPreset(activeTextForMenu.text);document.getElementById('customContextMenu').style.display='none'}
window.addEventListener('contextmenu',e=>{if(e.target.tagName==='CANVAS')e.preventDefault()});
function initHistory(id){if(!pageHistory[id])pageHistory[id]={undo:[],redo:[]}}
function saveHistory(c){const id=c.getElement().id;initHistory(id);if(pageHistory[id].undo.length>20)pageHistory[id].undo.shift();pageHistory[id].undo.push(JSON.stringify(c.toJSON(['id'])));pageHistory[id].redo=[]}
function undo(c){const id=c.getElement().id;initHistory(id);if(pageHistory[id].undo.length===0)return;pageHistory[id].redo.push(JSON.stringify(c.toJSON(['id'])));loadCanvasState(c,pageHistory[id].undo.pop())}
function loadCanvasState(c,j){const json=JSON.parse(j);const bg=c.backgroundImage;c.loadFromJSON(json,()=>{c.setBackgroundImage(bg,c.renderAll.bind(c));applyToolSettings(c)})}
window.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&!e.shiftKey&&e.key.toLowerCase()==='z'){e.preventDefault();activeCanvases.forEach(i=>undo(i.canvas))}if(e.key==='Delete'||e.key==='Backspace'){if(document.activeElement.tagName==='TEXTAREA'||document.activeElement.tagName==='INPUT')return;activeCanvases.forEach(i=>{const objs=i.canvas.getActiveObjects();if(objs.length){saveHistory(i.canvas);i.canvas.discardActiveObject();objs.forEach(o=>i.canvas.remove(o))}})}});
function attachHistoryEvents(c){c.on('object:modified',()=>saveHistory(c));c.on('path:created',()=>saveHistory(c))}
async function saveProject(){if(projectFiles.length===0)return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');showLoading(!0);try{const p=projectFiles.map(async f=>{const b=await readFileAsDataURL(f.file);return{name:f.name,type:f.type,selectedPages:f.selectedPages,data:b}});const d=await Promise.all(p);const pj={version:"1.0",timestamp:new Date().toISOString(),files:d,presets:textPresets,masterStamps:masterStampsJSON,slots:{1:localStorage.getItem('pdfstamp_slot_1_pos'),2:localStorage.getItem('pdfstamp_slot_2_pos'),3:localStorage.getItem('pdfstamp_slot_3_pos'),4:localStorage.getItem('pdfstamp_slot_4_pos'),5:localStorage.getItem('pdfstamp_slot_5_pos')}};saveAs(new Blob([JSON.stringify(pj)],{type:"application/json"}),`PDFStamp_Project_${Date.now()}.pdfstamp`)}catch(e){alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+e.message)}showLoading(!1)}
function loadProject(input){const f=input.files[0];if(!f)return;showLoading(!0);const r=new FileReader();r.onload=async e=>{try{const d=JSON.parse(e.target.result);textPresets=d.presets||[];localStorage.setItem('pdfstamp_presets',JSON.stringify(textPresets));renderPresets();if(d.masterStamps){masterStampsJSON=d.masterStamps;localStorage.setItem('pdfstamp_master_pos',masterStampsJSON)}if(d.slots){for(let k in d.slots)if(d.slots[k])localStorage.setItem(`pdfstamp_slot_${k}_pos`,d.slots[k])}projectFiles=[];activeCanvases=[];for(let fd of d.files){const res=await fetch(fd.data);const blob=await res.blob();const rf=new File([blob],fd.name,{type:fd.type});let doc=null,p=1;if(fd.type==='application/pdf'){const ab=await rf.arrayBuffer();doc=await pdfjsLib.getDocument(ab).promise;p=doc.numPages}projectFiles.push({id:Date.now()+Math.random().toString(16).slice(2),file:rf,name:fd.name,type:fd.type,pdfDoc:doc,totalPages:p,selectedPages:fd.selectedPages})}renderSidebar();await renderRightPanel();alert('‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢')}catch(err){alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: '+err.message)}showLoading(!1);input.value=''};r.readAsText(f)}
function adjustZoom(d){currentZoom+=d;if(currentZoom<.1)currentZoom=.1;if(currentZoom>5)currentZoom=5;document.getElementById('scalableContent').style.transform=`scale(${currentZoom})`;document.getElementById('zoomDisplay').innerText=Math.round(currentZoom*100)+'%'}
document.getElementById('docUpload').addEventListener('change',async e=>{const fs=Array.from(e.target.files);if(!fs.length)return;showLoading(!0);for(let f of fs){let p=1,doc=null;if(f.type==='application/pdf'){const ab=await f.arrayBuffer();doc=await pdfjsLib.getDocument(ab).promise;p=doc.numPages}projectFiles.push({id:Date.now()+Math.random().toString(16).slice(2),file:f,name:f.name,type:f.type,pdfDoc:doc,totalPages:p,selectedPages:[1]})}renderSidebar();renderRightPanel();showLoading(!1);e.target.value=''});
function renderSidebar(){const l=document.getElementById('fileList');l.innerHTML='';projectFiles.forEach(d=>{const i=document.createElement('div');i.className='file-item';const h=document.createElement('div');h.className='file-header';const w=document.createElement('div');w.style.display='flex';w.style.alignItems='center';w.innerHTML=`<span>üìÑ ${d.name}</span>`;const ab=document.createElement('button');ab.className='btn-all';ab.innerText='All';ab.onclick=e=>{e.stopPropagation();toggleAllPages(d.id)};w.appendChild(ab);h.appendChild(w);const rb=document.createElement('span');rb.className='file-remove';rb.innerHTML='&times;';rb.onclick=e=>{e.stopPropagation();removeFile(d.id)};h.appendChild(rb);i.appendChild(h);const pc=document.createElement('div');pc.className='page-selector';for(let n=1;n<=d.totalPages;n++){const pb=document.createElement('div');pb.innerText=n;pb.className=d.selectedPages.includes(n)?'page-btn selected':'page-btn';pb.onclick=e=>{e.stopPropagation();togglePageSelection(d.id,n)};pc.appendChild(pb)}i.appendChild(pc);l.appendChild(i)})}
function toggleAllPages(id){const d=projectFiles.find(f=>f.id===id);if(!d)return;if(d.selectedPages.length===d.totalPages)d.selectedPages=[];else d.selectedPages=Array.from({length:d.totalPages},(_,i)=>i+1);renderSidebar();renderRightPanel()}
function togglePageSelection(id,n){const d=projectFiles.find(f=>f.id===id);if(!d)return;if(d.selectedPages.includes(n))d.selectedPages=d.selectedPages.filter(p=>p!==n);else{d.selectedPages.push(n);d.selectedPages.sort((a,b)=>a-b)}renderSidebar();renderRightPanel()}
function removeFile(id){projectFiles=projectFiles.filter(f=>f.id!==id);renderSidebar();renderRightPanel()}
async function renderRightPanel(){const c=document.getElementById('scalableContent');c.innerHTML='';activeCanvases=[];if(!projectFiles.length){c.innerHTML='<div class="empty-state">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>';return}let has=!1;for(let d of projectFiles){for(let n of d.selectedPages){has=!0;const w=document.createElement('div');w.className='canvas-wrapper-card';const l=document.createElement('div');l.className='page-label';l.innerHTML=`‡πÑ‡∏ü‡∏•‡πå: <span>${d.name}</span> - ‡∏´‡∏ô‡πâ‡∏≤ <span>${n}</span>`;w.appendChild(l);const el=document.createElement('canvas');el.id=`c_${d.id}_${n}`;w.appendChild(el);c.appendChild(w);const f=new fabric.Canvas(el.id);f.on('mouse:down',opt=>{if(opt.e.button===2&&opt.target&&opt.target.type==='i-text'){activeTextForMenu=opt.target;showContextMenu(opt.e.clientX,opt.e.clientY);f.setActiveObject(opt.target);f.renderAll()}else{document.getElementById('customContextMenu').style.display='none'}});attachHistoryEvents(f);applyToolSettings(f);let wd,ht,url;if(d.type==='application/pdf'){const p=await d.pdfDoc.getPage(n);const v=p.getViewport({scale:2});const t=document.createElement('canvas');t.width=v.width;t.height=v.height;await p.render({canvasContext:t.getContext('2d'),viewport:v}).promise;url=t.toDataURL();wd=v.width;ht=v.height}else{url=await readFileAsDataURL(d.file);const img=await loadImage(url);wd=img.width;ht=img.height}await new Promise(r=>{fabric.Image.fromURL(url,img=>{f.setWidth(wd);f.setHeight(ht);f.setBackgroundImage(img,f.renderAll.bind(f));r()})});if(masterStampsJSON)await applyMasterStamps(f);activeCanvases.push({fileId:d.id,pageNum:n,canvas:f})}}if(!has)c.innerHTML='<div class="empty-state">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢</div>';setTool(currentTool)}
document.getElementById('stampUpload').addEventListener('change',e=>{Array.from(e.target.files).forEach(f=>{const r=new FileReader();r.onload=ev=>{addToGallery(ev.target.result);addStampToAll(ev.target.result)};r.readAsDataURL(f)})});
function addToGallery(s){const i=document.createElement('img');i.src=s;i.className='stamp-thumb';i.onclick=()=>addStampToAll(s);document.getElementById('stampGallery').appendChild(i)}
function addStampToAll(u){if(!activeCanvases.length)return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£');activeCanvases.forEach(i=>{saveHistory(i.canvas);fabric.Image.fromURL(u,img=>{img.scale(.5);img.set({left:i.canvas.width/2-(img.width*img.scaleX)/2,top:i.canvas.height/2-(img.height*img.scaleY)/2});i.canvas.add(img);i.canvas.setActiveObject(img)})});setTool('select')}
function saveToCurrentSlot(){if(!activeCanvases.length)return;const s=document.getElementById('slotSelect').value;const c=activeCanvases[0].canvas;const j=JSON.stringify(c.toJSON(['id']));localStorage.setItem(`pdfstamp_slot_${s}_pos`,j);const o=c.getObjects().find(ob=>ob.type==='image');if(o)localStorage.setItem(`pdfstamp_slot_${s}_img`,o.getSrc());localStorage.setItem('pdfstamp_last_slot',s);masterStampsJSON=j;alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Slot ${s} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`)}
function loadFromCurrentSlot(){loadFromSlot(document.getElementById('slotSelect').value)}
function loadFromSlot(s,silent=!1){const p=localStorage.getItem(`pdfstamp_slot_${s}_pos`);const i=localStorage.getItem(`pdfstamp_slot_${s}_img`);if(p){masterStampsJSON=p;localStorage.setItem('pdfstamp_last_slot',s);if(i)addToGallery(i);if(activeCanvases.length>0)renderRightPanel()}else{if(!silent)alert(`Slot ${s} ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤`);masterStampsJSON=null}}
function clearAllSignatures(){if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?'))return;activeCanvases.forEach(i=>{saveHistory(i.canvas);i.canvas.clear()});renderRightPanel()}
function applyMasterStamps(c){return new Promise(r=>{fabric.util.enlivenObjects(JSON.parse(masterStampsJSON),objs=>{objs.forEach(o=>{o.set('dirty',!0);c.add(o)});c.renderAll();r()})})}
function downloadAllFiles(){const f=document.getElementById('dlFormat').value;if(f==='pdf')downloadAllFilesPDFZip();else downloadAllFilesJPGZip()}
async function downloadAllFilesPDFZip(){if(!projectFiles.length)return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå');showLoading(!0);const z=new JSZip();const{jsPDF}=window.jspdf;for(let f of projectFiles){const pdf=new jsPDF();pdf.deletePage(1);for(let i=1;i<=f.totalPages;i++){const{data,width,height}=await getRenderedPageData(f,i,f.selectedPages.includes(i));const o=width>height?'l':'p';pdf.addPage([width,height],o);pdf.addImage(data,'JPEG',0,0,width,height)}z.file(`${f.name}_signed.pdf`,pdf.output('blob'))}saveAs(await z.generateAsync({type:"blob"}),"Signed_Documents.zip");showLoading(!1)}
async function downloadAllFilesJPGZip(){if(!projectFiles.length)return alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå');showLoading(!0);const z=new JSZip();for(let f of projectFiles){const folder=z.folder(f.name);for(let i=1;i<=f.totalPages;i++){const{data}=await getRenderedPageData(f,i,f.selectedPages.includes(i));folder.file(`Page_${i}.jpg`,await(await fetch(data)).blob())}}saveAs(await z.generateAsync({type:"blob"}),"Signed_Images_JPG.zip");showLoading(!1)}
async function getRenderedPageData(d,n,f=!0){const a=activeCanvases.find(c=>c.fileId===d.id&&c.pageNum===n);if(a&&f){a.canvas.discardActiveObject();a.canvas.renderAll();return{data:a.canvas.toDataURL({format:'jpeg',quality:.8}),width:a.canvas.width,height:a.canvas.height}}else return await renderOffScreen(d,n,f)}
async function renderOffScreen(d,n,s){const el=document.createElement('canvas');const f=new fabric.Canvas(el);let w,h;if(d.type==='application/pdf'){const p=await d.pdfDoc.getPage(n);const v=p.getViewport({scale:2});w=v.width;h=v.height;el.width=w;el.height=h;await p.render({canvasContext:el.getContext('2d'),viewport:v}).promise;const u=el.toDataURL();await new Promise(r=>fabric.Image.fromURL(u,img=>{f.setWidth(w);f.setHeight(h);f.setBackgroundImage(img,r)}))}else{const u=await readFileAsDataURL(d.file);const img=await loadImage(u);w=img.width;h=img.height;await new Promise(r=>fabric.Image.fromURL(u,im=>{f.setWidth(w);f.setHeight(h);f.setBackgroundImage(im,r)}))}if(s&&masterStampsJSON)await applyMasterStamps(f);const data=f.toDataURL({format:'jpeg',quality:.8});f.dispose();return{data,width:w,height:h}}
function readFileAsDataURL(f){return new Promise(r=>{const rd=new FileReader();rd.onload=e=>r(e.target.result);rd.readAsDataURL(f)})}
function loadImage(u){return new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=u})}
function showLoading(s){document.getElementById('loadingOverlay').style.display=s?'flex':'none'}
</script>
</body>
</html>
