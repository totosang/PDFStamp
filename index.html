<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>PDFStamp Pro V16 Minified</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
<style>*{box-sizing:border-box}body{font-family:Sarabun,'TH Sarabun PSK',sans-serif;margin:0;padding:0;height:100vh;display:flex;flex-direction:column;overflow:hidden;background:#333}.header-bar{height:50px;background:#222;color:#fff;display:flex;align-items:center;justify-content:center;gap:20px;font-size:1.5rem;font-weight:700;border-bottom:1px solid #444;flex-shrink:0;z-index:20;position:relative}.header-bar span{color:#007bff}.project-btn-group{position:absolute;right:20px;display:flex;gap:10px}.btn-proj{font-size:.8rem;padding:5px 10px;border-radius:4px;cursor:pointer;border:1px solid #555;background:#444;color:#fff}.btn-proj:hover{background:#666}.main-container{display:flex;flex-grow:1;overflow:hidden;height:calc(100vh - 50px)}.sidebar{width:320px;background:#2c3e50;color:#fff;display:flex;flex-direction:column;border-right:1px solid #444;padding:15px;overflow-y:auto;flex-shrink:0;z-index:2}.sidebar h2{margin-top:0;font-size:1.1rem;border-bottom:1px solid #4a6278;padding-bottom:10px;color:#ecf0f1}.upload-box{background:#34495e;padding:10px;border-radius:6px;text-align:center;margin-bottom:15px;border:2px dashed #7f8c8d;cursor:pointer;transition:.2s}.upload-box:hover{background:#3d566e;border-color:#bdc3c7}.preset-box{margin-top:20px;border-top:1px solid #4a6278;padding-top:15px}.preset-input-group{display:flex;gap:5px;margin-bottom:10px}.preset-input{flex-grow:1;padding:5px;border-radius:4px;border:none}.preset-list{display:flex;flex-direction:column;gap:5px}.preset-item{background:#34495e;padding:8px;border-radius:4px;cursor:pointer;display:flex;justify-content:space-between;align-items:center}.preset-item:hover{background:#3d566e;border-left:3px solid #007bff}.preset-del{color:#e74c3c;font-weight:700;cursor:pointer;padding:0 5px}.file-list{display:flex;flex-direction:column;gap:10px}.file-item{background:#fff;color:#333;border-radius:5px;padding:10px;border-left:5px solid transparent}.file-header{display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:.85rem;margin-bottom:8px}.file-remove{color:red;cursor:pointer;font-size:1.2rem;padding:0 5px}.btn-all{background:#17a2b8;color:#fff;border:none;border-radius:3px;padding:2px 6px;font-size:.7rem;cursor:pointer;margin-left:5px}.page-selector{display:flex;flex-wrap:wrap;gap:4px}.page-btn{width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:.8rem;border:1px solid #ccc;background:#f8f9fa;cursor:pointer;border-radius:3px;color:#ccc}.page-btn.selected{background:#28a745;color:#fff;border-color:#28a745;font-weight:700}.workspace{flex-grow:1;background:#555;display:flex;flex-direction:column;position:relative;height:100%}.toolbar{background:#fff;padding:5px 15px;display:flex;gap:10px;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,.2);z-index:10;height:60px;flex-shrink:0;overflow-x:auto}.canvas-scroll-area{flex-grow:1;overflow:auto;padding:30px;background:#666;display:flex;flex-direction:column;align-items:center}#scalableContent{display:flex;flex-direction:column;gap:30px;transform-origin:top center;transition:transform .1s ease-out}.canvas-wrapper-card{background:#fff;box-shadow:0 5px 15px rgba(0,0,0,.3);position:relative}.page-label{position:absolute;top:-28px;left:0;color:#fff;font-size:.9rem;background:#444;padding:4px 10px;border-radius:4px 4px 0 0;display:flex;align-items:center;gap:5px;white-space:nowrap}.page-label span{font-weight:700;color:#4db8ff}input[type=file]{display:none}.btn{padding:6px 10px;border:none;border-radius:4px;cursor:pointer;font-size:.85rem;font-weight:700;transition:.2s;white-space:nowrap;display:flex;align-items:center;gap:5px}.btn-blue{background:#007bff;color:#fff}.btn-green{background:#27ae60;color:#fff}.btn-red{background:#e74c3c;color:#fff}.btn-orange{background:#e67e22;color:#fff}.btn-dark{background:#343a40;color:#fff}.btn.active-tool{box-shadow:inset 0 0 0 2px #222;transform:scale(.95);background-color:#ffd700;color:#000}.control-group{display:flex;align-items:center;gap:5px;padding:0 10px;border-left:1px solid #ddd}.download-group{margin-left:auto;border-left:1px solid #ddd;padding-left:10px;display:flex;gap:5px}.format-select{padding:6px;border:1px solid #ccc;border-radius:4px;font-weight:700;color:#333;cursor:pointer}.slot-select{padding:6px;border:2px solid #e67e22;border-radius:4px;font-weight:700;color:#e67e22;cursor:pointer;background:#fff5eb}.stamp-gallery-container{display:flex;align-items:center;gap:8px;overflow-x:auto;max-width:150px;height:100%;padding:0 5px}.stamp-thumb{height:40px;width:auto;object-fit:contain;border:2px solid transparent;cursor:pointer;background:#fff;padding:2px;border-radius:4px;box-shadow:0 2px 4px rgba(0,0,0,.1)}#loadingOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);color:#fff;z-index:2000;justify-content:center;align-items:center;flex-direction:column}.empty-state{color:#ccc;text-align:center;margin-top:50px;font-size:1.2rem;width:100%}input[type=color]{width:30px;height:30px;border:none;padding:0;background:none;cursor:pointer}input[type=range]{width:80px}.color-dot{width:20px;height:20px;border-radius:50%;cursor:pointer;border:2px solid #ddd;transition:transform .1s}.color-dot:hover{transform:scale(1.2);border-color:#555}#customContextMenu{display:none;position:fixed;z-index:3000;background:#fff;border:1px solid #bbb;border-radius:4px;box-shadow:2px 2px 10px rgba(0,0,0,.2);min-width:150px}.context-menu-item{padding:10px 15px;cursor:pointer;font-size:.9rem;color:#333;display:flex;align-items:center;gap:8px}.context-menu-item:hover{background:#f0f7ff;color:#007bff}.cursor-pen .upper-canvas{cursor:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewport="0 0 24 24" style="fill:black;stroke:white;stroke-width:1px;"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>') 0 24,auto!important}.cursor-highlight .upper-canvas{cursor:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewport="0 0 24 24" style="fill:orange;stroke:black;stroke-width:1px;"><path d="M15.25 2.25l-2.5 2.5 5 5 2.5-2.5-5-5zM2.25 15.25l5 5 10.5-10.5-5-5-10.5 10.5z"/></svg>') 0 24,auto!important}.cursor-text .upper-canvas{cursor:text!important}.cursor-crosshair .upper-canvas{cursor:crosshair!important}</style>
</head>
<body>
<div id="customContextMenu"><div class="context-menu-item" onclick="addTextToPresetFromMenu()">‚≠ê ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢</div></div>
<div id="loadingOverlay"><h2>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</h2><p id="loadingText">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</p></div>
<div class="header-bar">PDF<span>Stamp</span><div class="project-btn-group"><button class="btn-proj" onclick="saveProject()">üíæ Save Project</button><label class="btn-proj" for="projectLoad">üìÇ Open Project</label><input type="file" id="projectLoad" accept=".pdfstamp" style="display:none" onchange="loadProject(this)"></div></div>
<div class="main-container">
<div class="sidebar"><h2>üìÇ 1. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h2><label for="docUpload" class="upload-box"><span style="font-size:1.5rem">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</span><p>(PDF ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û)</p></label><input type="file" id="docUpload" accept="image/*,application/pdf" multiple><div id="fileList" class="file-list"></div><div class="preset-box"><h2>üìù ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡πà‡∏≠‡∏¢</h2><div class="preset-input-group"><input type="text" id="newPresetInput" class="preset-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter..."><button class="btn btn-green" onclick="addPreset()">+</button></div><div id="presetList" class="preset-list"></div></div></div>
<div class="workspace"><div class="toolbar"><div class="control-group"><button id="tool-select" class="btn btn-dark active-tool" onclick="setTool('select')">üëÜ</button><button id="tool-pen" class="btn btn-dark" onclick="setTool('pen')">‚úèÔ∏è</button><button id="tool-highlight" class="btn btn-dark" onclick="setTool('highlight')">üñçÔ∏è</button><button id="tool-text" class="btn btn-dark" onclick="setTool('text')">üÖ∞Ô∏è</button></div><div class="control-group"><div class="color-dot" style="background:#000" onclick="setPaletteColor('#000000')"></div><div class="color-dot" style="background:#00f" onclick="setPaletteColor('#0000ff')"></div><div class="color-dot" style="background:red;" onclick="setPaletteColor('#ff0000')"></div><div class="color-dot" style="background:#ff0" onclick="setPaletteColor('#FFFF00')"></div><input type="color" id="colorPicker" value="#000000" onchange="updateDrawSettings()"><input type="range" id="sizeSlider" min="1" max="50" value="3" oninput="updateDrawSettings()"></div><label for="stampUpload" class="btn btn-blue">¬©Ô∏è ‡∏ï‡∏£‡∏≤</label><input type="file" id="stampUpload" accept="image/png,image/jpeg" multiple><div class="stamp-gallery-container" id="stampGallery"></div><div class="control-group"><select id="slotSelect" class="slot-select" onchange="loadFromSlot(this.value)"><option value="1">Slot 1</option><option value="2">Slot 2</option><option value="3">Slot 3</option><option value="4">Slot 4</option><option value="5">Slot 5</option></select><button class="btn btn-orange" onclick="saveToCurrentSlot()">üíæ</button><button class="btn btn-purple" onclick="loadFromCurrentSlot()">üìÇ</button></div><div class="control-group"><button class="btn btn-red" onclick="clearAllSignatures()">‚ùå</button></div><div class="control-group"><button class="btn btn-dark" onclick="adjustZoom(-.1)">üîç-</button><span id="zoomDisplay" class="zoom-label" style="width:35px">100%</span><button class="btn btn-dark" onclick="adjustZoom(.1)">üîç+</button></div><div class="download-group"><select id="dlFormat" class="format-select"><option value="pdf">PDF</option><option value="jpg">JPG</option></select><button class="btn btn-green" onclick="downloadAllFiles()">‚¨áÔ∏è</button></div></div><div class="canvas-scroll-area"><div id="scalableContent"><div class="empty-state">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div></div></div></div></div>
<script>
let projectFiles=[],activeCanvases=[],masterStampsJSON=null,currentZoom=1,currentTool="select",drawColor="#000000",drawWidth=3,isDrawingLine=!1,lineToDraw=null,pageHistory={},textPresets=[],activeTextForMenu=null;pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";window.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("pdfstamp_last_slot")||"1";document.getElementById("slotSelect").value=e,loadFromSlot(e,!0);const t=localStorage.getItem("pdfstamp_presets");t&&(textPresets=JSON.parse(t)),renderPresets(),document.getElementById("newPresetInput").addEventListener("keydown",e=>{"Enter"===e.key&&addPreset()}),window.addEventListener("click",()=>document.getElementById("customContextMenu").style.display="none")});function setTool(e){currentTool=e,"highlight"===e&&"#000000"===drawColor&&setPaletteColor("#FFFF00"),document.querySelectorAll(".btn").forEach(e=>e.classList.remove("active-tool")),document.getElementById(`tool-${e}`)&&document.getElementById(`tool-${e}`).classList.add("active-tool"),activeCanvases.forEach(t=>{const n=t.canvas.wrapperEl;n.classList.remove("cursor-pen","cursor-highlight","cursor-text","cursor-crosshair"),"pen"===e?n.classList.add("cursor-pen"):"highlight"===e?n.classList.add("cursor-highlight"):"text"===e&&n.classList.add("cursor-text"),applyToolSettings(t.canvas)})}function setPaletteColor(e){document.getElementById("colorPicker").value=e,updateDrawSettings()}function updateDrawSettings(){drawColor=document.getElementById("colorPicker").value,drawWidth=parseInt(document.getElementById("sizeSlider").value,10),activeCanvases.forEach(e=>{const t=e.canvas.getActiveObject();t&&(saveHistory(e.canvas),"i-text"===t.type?t.set({fill:drawColor}):"path"===t.type?t.set({stroke:drawColor,strokeWidth:drawWidth}):"line"===t.type&&t.set({stroke:drawColor,strokeWidth:t.opacity<1?6*drawWidth:drawWidth}),e.canvas.renderAll()),e.canvas.freeDrawingBrush&&(e.canvas.freeDrawingBrush.color=drawColor,e.canvas.freeDrawingBrush.width=drawWidth)})}function applyToolSettings(e){e.isDrawingMode=!1,e.selection=!0,e.skipTargetFind=!1,e.defaultCursor="default",e.off("mouse:down",handleMouseDown),e.off("mouse:move",handleMouseMove),e.off("mouse:up",handleMouseUp),"pen"===currentTool?(e.isDrawingMode=!0,e.freeDrawingBrush=new fabric.PencilBrush(e),e.freeDrawingBrush.color=drawColor,e.freeDrawingBrush.width=drawWidth):("highlight"===currentTool||"text"===currentTool)&&(e.selection=!1,e.skipTargetFind=!0,e.on("mouse:down",handleMouseDown),e.on("mouse:move",handleMouseMove),e.on("mouse:up",handleMouseUp))}function handleMouseDown(e){const t=this,n=t.getPointer(e.e);if("text"===currentTool){saveHistory(t);const e=new fabric.IText("‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°",{left:n.x,top:n.y,fontFamily:"TH Sarabun PSK, Sarabun, sans-serif",fill:"#0000ff",fontSize:16,cursorColor:"blue"});return t.add(e),t.setActiveObject(e),e.enterEditing(),void setTool("select")}if("highlight"===currentTool){isDrawingLine=!0,saveHistory(t);const e=6*drawWidth;lineToDraw=new fabric.Line([n.x,n.y,n.x,n.y],{strokeWidth:e,fill:drawColor,stroke:drawColor,opacity:.35,selectable:!0,strokeLineCap:"butt",evented:!0,originX:"center",originY:"center"}),t.add(lineToDraw)}}function handleMouseMove(e){if(isDrawingLine){const t=this,n=t.getPointer(e.e);lineToDraw.set({x2:n.x,y2:n.y}),t.renderAll()}}function handleMouseUp(e){isDrawingLine&&(isDrawingLine=!1,lineToDraw.setCoords())}function renderPresets(){const e=document.getElementById("presetList");e.innerHTML="",textPresets.forEach((t,n)=>{const a=document.createElement("div");a.className="preset-item",a.innerHTML=`<span onclick="applyPreset('${t}')">${t}</span> <span class="preset-del" onclick="delPreset(${n})">&times;</span>`,e.appendChild(a)})}function addPreset(e){null===e&&(e=(t=document.getElementById("newPresetInput")).value.trim(),e&&(t.value=""));var t;e&&!textPresets.includes(e)&&(textPresets.push(e),localStorage.setItem("pdfstamp_presets",JSON.stringify(textPresets)),renderPresets())}function delPreset(e){textPresets.splice(e,1),localStorage.setItem("pdfstamp_presets",JSON.stringify(textPresets)),renderPresets()}function applyPreset(e){if(0===activeCanvases.length)return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");const t=activeCanvases[0].canvas;saveHistory(t);const n=new fabric.IText(e,{left:t.width-20,top:t.height-20,fontFamily:"TH Sarabun PSK, Sarabun, sans-serif",fill:"#0000ff",fontSize:16,originX:"right",originY:"bottom",cursorColor:"blue"});t.add(n),t.setActiveObject(n),t.renderAll(),setTool("select")}function showContextMenu(e,t){const n=document.getElementById("customContextMenu");n.style.display="block",n.style.left=e+"px",n.style.top=t+"px"}function addTextToPresetFromMenu(){activeTextForMenu&&activeTextForMenu.text&&addPreset(activeTextForMenu.text),document.getElementById("customContextMenu").style.display="none"}function initHistory(e){pageHistory[e]||(pageHistory[e]={undo:[],redo:[]})}function saveHistory(e){const t=e.getElement().id;initHistory(t),pageHistory[t].undo.length>20&&pageHistory[t].undo.shift(),pageHistory[t].undo.push(JSON.stringify(e.toJSON(["id"]))),pageHistory[t].redo=[]}function undo(e){const t=e.getElement().id;initHistory(t);if(0!==pageHistory[t].undo.length){const n=JSON.stringify(e.toJSON(["id"]));pageHistory[t].redo.push(n),loadCanvasState(e,pageHistory[t].undo.pop())}}function loadCanvasState(e,t){const n=JSON.parse(t),a=e.backgroundImage;e.loadFromJSON(n,function(){e.setBackgroundImage(a,e.renderAll.bind(e)),applyToolSettings(e)})}function attachHistoryEvents(e){e.on("object:modified",()=>saveHistory(e)),e.on("path:created",()=>saveHistory(e))}async function saveProject(){if(0===projectFiles.length)return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");showLoading(!0);try{const e=await Promise.all(projectFiles.map(async e=>({name:e.name,type:e.type,selectedPages:e.selectedPages,data:await readFileAsDataURL(e.file)}))),t={version:"1.0",timestamp:new Date().toISOString(),files:e,presets:textPresets,masterStamps:masterStampsJSON,slots:{1:localStorage.getItem("pdfstamp_slot_1_pos"),2:localStorage.getItem("pdfstamp_slot_2_pos"),3:localStorage.getItem("pdfstamp_slot_3_pos"),4:localStorage.getItem("pdfstamp_slot_4_pos"),5:localStorage.getItem("pdfstamp_slot_5_pos")}};saveAs(new Blob([JSON.stringify(t)],{type:"application/json"}),`PDFStamp_Project_${Date.now()}.pdfstamp`)}catch(e){alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+e.message)}showLoading(!1)}function loadProject(e){const t=e.files[0];if(t){showLoading(!0);const n=new FileReader;n.onload=async t=>{try{const n=JSON.parse(t.target.result);if(textPresets=n.presets||[],localStorage.setItem("pdfstamp_presets",JSON.stringify(textPresets)),renderPresets(),n.masterStamps&&(masterStampsJSON=n.masterStamps,localStorage.setItem("pdfstamp_master_pos",masterStampsJSON)),n.slots)for(let e in n.slots)n.slots[e]&&localStorage.setItem(`pdfstamp_slot_${e}_pos`,n.slots[e]);projectFiles=[],activeCanvases=[];for(let e of n.files){const t=await fetch(e.data),n=await t.blob(),a=new File([n],e.name,{type:e.type});let r=null,l=1;if("application/pdf"===e.type){const e=await a.arrayBuffer();r=await pdfjsLib.getDocument(e).promise,l=r.numPages}projectFiles.push({id:Date.now()+Math.random().toString(16).slice(2),file:a,name:e.name,type:e.type,pdfDoc:r,totalPages:l,selectedPages:e.selectedPages})}renderSidebar(),await renderRightPanel(),alert("‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢")}catch(e){alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+e.message)}showLoading(!1),e.value=""},n.readAsText(t)}}function adjustZoom(e){currentZoom+=e,currentZoom<.1&&(currentZoom=.1),currentZoom>5&&(currentZoom=5),document.getElementById("scalableContent").style.transform=`scale(${currentZoom})`,document.getElementById("zoomDisplay").innerText=Math.round(100*currentZoom)+"%"}function toggleAllPages(e){const t=projectFiles.find(t=>t.id===e);t&&(t.selectedPages.length===t.totalPages?t.selectedPages=[]:t.selectedPages=Array.from({length:t.totalPages},(e,t)=>t+1),renderSidebar(),renderRightPanel())}function togglePageSelection(e,t){const n=projectFiles.find(t=>t.id===e);n&&(n.selectedPages.includes(t)?n.selectedPages=n.selectedPages.filter(e=>e!==t):(n.selectedPages.push(t),n.selectedPages.sort((e,t)=>e-t)),renderSidebar(),renderRightPanel())}function removeFile(e){projectFiles=projectFiles.filter(t=>t.id!==e),renderSidebar(),renderRightPanel()}async function renderRightPanel(){const e=document.getElementById("scalableContent");if(e.innerHTML="",activeCanvases=[],0===projectFiles.length)return void(e.innerHTML='<div class="empty-state">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>');let t=!1;for(let n of projectFiles)for(let a of n.selectedPages){t=!0;const r=document.createElement("div");r.className="canvas-wrapper-card";const l=document.createElement("div");l.className="page-label",l.innerHTML=`‡πÑ‡∏ü‡∏•‡πå: <span>${n.name}</span> - ‡∏´‡∏ô‡πâ‡∏≤ <span>${a}</span>`,r.appendChild(l);const o=document.createElement("canvas");o.id=`c_${n.id}_${a}`,r.appendChild(o),e.appendChild(r);const s=new fabric.Canvas(o.id);s.on("mouse:down",function(e){2===e.e.button&&e.target&&"i-text"===e.target.type?(activeTextForMenu=e.target,showContextMenu(e.e.clientX,e.e.clientY),s.setActiveObject(e.target),s.renderAll()):document.getElementById("customContextMenu").style.display="none"}),attachHistoryEvents(s),applyToolSettings(s);let i,c,d;if("application/pdf"===n.type){const e=await n.pdfDoc.getPage(a),t=e.getViewport({scale:2});const r=document.createElement("canvas");r.width=t.width,r.height=t.height,await e.render({canvasContext:r.getContext("2d"),viewport:t}).promise,d=r.toDataURL(),i=t.width,c=t.height}else{d=await readFileAsDataURL(n.file);const e=await loadImage(d);i=e.width,c=e.height}await new Promise(e=>{fabric.Image.fromURL(d,t=>{s.setWidth(i),s.setHeight(c),s.setBackgroundImage(t,s.renderAll.bind(s)),e()})}),masterStampsJSON&&await applyMasterStamps(s),activeCanvases.push({fileId:n.id,pageNum:a,canvas:s})}t||(e.innerHTML='<div class="empty-state">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢</div>'),setTool(currentTool)}function saveToCurrentSlot(){if(0!==activeCanvases.length){const e=document.getElementById("slotSelect").value,t=activeCanvases[0].canvas,n=JSON.stringify(t.toJSON(["id"]));localStorage.setItem(`pdfstamp_slot_${e}_pos`,n);const a=t.getObjects().find(e=>"image"===e.type);a&&localStorage.setItem(`pdfstamp_slot_${e}_img`,a.getSrc()),localStorage.setItem("pdfstamp_last_slot",e),masterStampsJSON=n,alert(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Slot ${e} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`)}}function loadFromSlot(e,t=!1){const n=localStorage.getItem(`pdfstamp_slot_${e}_pos`),a=localStorage.getItem(`pdfstamp_slot_${e}_img`);n?(masterStampsJSON=n,localStorage.setItem("pdfstamp_last_slot",e),t||console.log(`Loaded Slot ${e}`),a&&addToGallery(a),activeCanvases.length>0&&renderRightPanel()):(t||alert(`Slot ${e} ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤`),masterStampsJSON=null)}function downloadAllFiles(){"pdf"===document.getElementById("dlFormat").value?downloadAllFilesPDFZip():downloadAllFilesJPGZip()}async function getRenderedPageData(e,t,n=!0){const a=activeCanvases.find(n=>n.fileId===e.id&&n.pageNum===t);return a&&n?(a.canvas.discardActiveObject(),a.canvas.renderAll(),{data:a.canvas.toDataURL({format:"jpeg",quality:.8}),width:a.canvas.width,height:a.canvas.height}):await renderOffScreen(e,t,n)}async function renderOffScreen(e,t,n){const a=document.createElement("canvas"),r=new fabric.Canvas(a);let l,o;if("application/pdf"===e.type){const n=await e.pdfDoc.getPage(t),s=n.getViewport({scale:2});l=s.width,o=s.height,a.width=l,a.height=o,await n.render({canvasContext:a.getContext("2d"),viewport:s}).promise;const i=a.toDataURL();await new Promise(e=>fabric.Image.fromURL(i,t=>{r.setWidth(l),r.setHeight(o),r.setBackgroundImage(t,e)}))}else{const t=await readFileAsDataURL(e.file),n=await loadImage(t);l=n.width,o=n.height,await new Promise(e=>fabric.Image.fromURL(t,t=>{r.setWidth(l),r.setHeight(o),r.setBackgroundImage(t,e)}))}n&&masterStampsJSON&&await applyMasterStamps(r);const s=r.toDataURL({format:"jpeg",quality:.8});return r.dispose(),{data:s,width:l,height:o}}window.addEventListener("contextmenu",e=>{"CANVAS"===e.target.tagName&&e.preventDefault()}),window.addEventListener("keydown",e=>{if((e.ctrlKey||e.metaKey)&&!e.shiftKey&&"z"===e.key.toLowerCase()&&(e.preventDefault(),activeCanvases.forEach(e=>undo(e))),"Delete"===e.key||"Backspace"===e.key){if("TEXTAREA"===document.activeElement.tagName||"INPUT"===document.activeElement.tagName)return;activeCanvases.forEach(e=>{const t=e.canvas.getActiveObjects();t.length&&(saveHistory(e.canvas),e.canvas.discardActiveObject(),t.forEach(t=>e.canvas.remove(t)))})}}),async function downloadAllFilesPDFZip(){if(0===projectFiles.length)return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå");showLoading(!0);const e=new JSZip,t=window.jspdf.jsPDF;for(let n of projectFiles){const a=new t;a.deletePage(1);for(let e=1;e<=n.totalPages;e++){const{data:t,width:r,height:l}=await getRenderedPageData(n,e,n.selectedPages.includes(e)),o=r>l?"l":"p";a.addPage([r,l],o),a.addImage(t,"JPEG",0,0,r,l)}e.file(`${n.name}_signed.pdf`,a.output("blob"))}saveAs(await e.generateAsync({type:"blob"}),"Signed_Documents.zip"),showLoading(!1)}async function downloadAllFilesJPGZip(){if(0===projectFiles.length)return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå");showLoading(!0);const e=new JSZip;for(let t of projectFiles){const n=e.folder(t.name);for(let e=1;e<=t.totalPages;e++){const{data:a}=await getRenderedPageData(t,e,t.selectedPages.includes(e));n.file(`Page_${e}.jpg`,await(await fetch(a)).blob())}}saveAs(await e.generateAsync({type:"blob"}),"Signed_Images_JPG.zip"),showLoading(!1)}function readFileAsDataURL(e){return new Promise(t=>{const n=new FileReader;n.onload=e=>t(e.target.result),n.readAsDataURL(e)})}function loadImage(e){return new Promise(t=>{const n=new Image;n.onload=()=>t(n),n.src=e})}function showLoading(e){document.getElementById("loadingOverlay").style.display=e?"flex":"none"}function clearAllSignatures(){confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")&&(activeCanvases.forEach(e=>{saveHistory(e.canvas),e.canvas.clear()}),renderRightPanel())}function loadFromCurrentSlot(){loadFromSlot(document.getElementById("slotSelect").value)}
</script></body></html>
