<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>PDFStamp Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>*{box-sizing:border-box}body{font-family:Sarabun,sans-serif;margin:0;height:100vh;display:flex;flex-direction:column;overflow:hidden;background:#333}.header-bar{height:50px;background:#222;color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;border-bottom:1px solid #444;z-index:20}.header-bar span{color:#007bff}.main-container{display:flex;flex-grow:1;overflow:hidden;height:calc(100vh - 50px)}.sidebar{width:320px;background:#2c3e50;color:#fff;display:flex;flex-direction:column;border-right:1px solid #444;padding:15px;overflow-y:auto;flex-shrink:0}.upload-box{background:#34495e;padding:15px;border-radius:6px;text-align:center;margin-bottom:15px;border:2px dashed #7f8c8d;cursor:pointer}.file-item{background:#fff;color:#333;border-radius:5px;padding:10px;margin-bottom:10px}.file-header{display:flex;justify-content:space-between;font-weight:700;font-size:.85rem;margin-bottom:8px}.page-btn{width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;font-size:.8rem;border:1px solid #ccc;background:#f8f9fa;cursor:pointer;margin:2px;border-radius:3px;color:#ccc}.page-btn.selected{background:#28a745;color:#fff;border-color:#28a745}.workspace{flex-grow:1;background:#555;display:flex;flex-direction:column;position:relative}.toolbar{background:#fff;padding:8px 15px;display:flex;gap:10px;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,.2);z-index:10;height:70px}.canvas-scroll-area{flex-grow:1;overflow:auto;padding:30px;background:#666;display:flex;flex-direction:column;align-items:center}#scalableContent{transform-origin:top center;display:flex;flex-direction:column;gap:30px}.canvas-wrapper-card{background:#fff;box-shadow:0 5px 15px rgba(0,0,0,.3);position:relative}.page-label{position:absolute;top:-28px;left:0;color:#fff;font-size:.9rem;background:#444;padding:4px 10px;border-radius:4px 4px 0 0}input[type=file]{display:none}.btn{padding:8px 12px;border:none;border-radius:4px;cursor:pointer;font-size:.85rem;font-weight:700;display:flex;align-items:center;gap:5px}.btn-blue{background:#007bff;color:#fff}.btn-green{background:#27ae60;color:#fff}.btn-red{background:#e74c3c;color:#fff}.btn-orange{background:#e67e22;color:#fff}.btn-purple{background:#6f42c1;color:#fff}.control-group{display:flex;align-items:center;gap:5px;padding:0 10px;border-left:1px solid #ddd}.download-group{margin-left:auto;display:flex;gap:5px}.stamp-gallery-container{display:flex;gap:8px;overflow-x:auto;max-width:250px}#loadingOverlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);color:#fff;z-index:2000;justify-content:center;align-items:center;flex-direction:column}</style>
</head>
<body>
<div id="loadingOverlay"><h2>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</h2></div>
<div class="header-bar">PDF<span>Stamp</span></div>
<div class="main-container">
    <div class="sidebar">
        <h2>üìÇ 1. ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h2>
        <label for="dUp" class="upload-box">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå <p>(PDF/Image)</p></label>
        <input type="file" id="dUp" multiple accept="image/*,application/pdf">
        <div id="fList"></div>
    </div>
    <div class="workspace">
        <div class="toolbar">
            <label for="sUp" class="btn btn-blue">¬©Ô∏è ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</label>
            <input type="file" id="sUp" multiple accept="image/*">
            <div class="stamp-gallery-container" id="sGal"></div>
            <div class="control-group">
                <select id="slot" style="padding:8px"><option value="1">S1</option><option value="2">S2</option><option value="3">S3</option></select>
                <button class="btn btn-orange" onclick="_sV()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button class="btn btn-purple" onclick="_lD()">üìÇ ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤</button>
            </div>
            <div class="control-group"><button class="btn btn-dark" onclick="_zm(-0.1)">‚ûñ</button><span id="zDs">100%</span><button class="btn btn-dark" onclick="_zm(0.1)">‚ûï</button></div>
            <div class="download-group"><select id="fmt" style="padding:8px"><option value="pdf">PDF</option><option value="jpg">JPG</option></select><button class="btn btn-green" onclick="_dl()">‚¨áÔ∏è ‡πÇ‡∏´‡∏•‡∏î</button></div>
        </div>
        <div class="canvas-scroll-area"><div id="scalableContent"></div></div>
    </div>
</div>
<script>
(function(){pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';let _pf=[],_ac=[],_ms=null,_z=1;const _q=s=>document.getElementById(s),_sc=_q('scalableContent'),_ld=_q('loadingOverlay');window._zm=d=>{_z+=d;_z=Math.max(0.1,Math.min(5,_z));_sc.style.transform=`scale(${_z})`;_q('zDs').innerText=Math.round(_z*100)+'%'};_q('dUp').onchange=async e=>{const fs=Array.from(e.target.files);if(!fs.length)return;_sL(1);for(let f of fs){let p=1,pdf=null;if(f.type==='application/pdf'){const b=await f.arrayBuffer();pdf=await pdfjsLib.getDocument(b).promise;p=pdf.numPages}_pf.push({id:Date.now()+Math.random(),file:f,name:f.name,type:f.type,pdfDoc:pdf,totalPages:p,selectedPages:[1]})}_rS();_rP();_sL(0);e.target.value=''};function _rS(){const l=_q('fList');l.innerHTML='';_pf.forEach(d=>{const i=document.createElement('div');i.className='file-item';i.innerHTML=`<div class="file-header"><span>üìÑ ${d.name}</span><span onclick="_rm('${d.id}')" style="color:red;cursor:pointer">&times;</span></div>`;const pC=document.createElement('div');pC.className='page-selector';for(let j=1;j<=d.totalPages;j++){const b=document.createElement('div');b.className='page-btn '+(d.selectedPages.includes(j)?'selected':'');b.innerText=j;b.onclick=()=>_tP(d.id,j);pC.appendChild(b)}i.appendChild(pC);l.appendChild(i)})}window._rm=id=>{_pf=_pf.filter(f=>f.id!=id);_rS();_rP()};function _tP(fid,p){const d=_pf.find(f=>f.id==fid);d.selectedPages.includes(p)?d.selectedPages=d.selectedPages.filter(x=>x!=p):d.selectedPages.push(p);d.selectedPages.sort((a,b)=>a-b);_rS();_rP()}async function _rP(){_sc.innerHTML='';_ac=[];if(!_pf.length)return;_sL(1);for(let d of _pf)for(let n of d.selectedPages){const w=document.createElement('div');w.className='canvas-wrapper-card';w.innerHTML=`<div class="page-label">${d.name} - P${n}</div>`;const cE=document.createElement('canvas');cE.id=`c_${d.id}_${n}`;w.appendChild(cE);_sc.appendChild(w);const fI=new fabric.Canvas(cE.id);let u,wt,ht;if(d.type==='application/pdf'){const p=await d.pdfDoc.getPage(n),v=p.getViewport({scale:2});const tC=document.createElement('canvas');tC.width=v.width;tC.height=v.height;await p.render({canvasContext:tC.getContext('2d'),viewport:v}).promise;u=tC.toDataURL();wt=v.width;ht=v.height}else{u=await _rF(d.file);const iO=await _lI(u);wt=iO.width;ht=iO.height}await new Promise(r=>fabric.Image.fromURL(u,img=>{fI.setWidth(wt);fI.setHeight(ht);fI.setBackgroundImage(img,fI.renderAll.bind(fI));r()}));if(_ms)await _aM(fI);_ac.push({fid:d.id,pn:n,canvas:fI})}_sL(0)}function _rF(f){return new Promise(r=>{const rd=new FileReader();rd.onload=e=>r(e.target.result);rd.readAsDataURL(f)})}function _lI(u){return new Promise(r=>{const i=new Image();i.onload=()=>r(i);i.src=u})}function _sL(s){_ld.style.display=s?'flex':'none'}window._sV=()=>{if(!_ac.length)return;const s=_q('slot').value,ob=_ac[0].canvas.getObjects();if(!ob.length)return alert('No stamps');const j=JSON.stringify(_ac[0].canvas.toJSON(['id']).objects);localStorage.setItem(`ps_s_${s}_p`,j);_ms=j;alert('Saved Slot '+s)};window._lD=()=>{const s=_q('slot').value,p=localStorage.getItem(`ps_s_${s}_p`);if(p){_ms=p;_rP()}else alert('Empty')};function _aM(c){return new Promise(r=>{fabric.util.enlivenObjects(JSON.parse(_ms),os=>{os.forEach(o=>c.add(o));c.renderAll();r()})})}window._dl=async()=>{const ft=_q('fmt').value;_sL(1);const z=new JSZip();if(ft==='pdf'){const {jsPDF:JP}=window.jspdf;for(let f of _pf){const pD=new JP();pD.deletePage(1);for(let i=1;i<=f.totalPages;i++){const {da,w,h}=await _gR(f,i);pD.addPage([w,h],w>h?'l':'p');pD.addImage(da,'JPEG',0,0,w,h)}z.file(`${f.name}_S.pdf`,pD.output('blob'))}}else{for(let f of _pf){const fd=z.folder(f.name);for(let i=1;i<=f.totalPages;i++){const {da}=await _gR(f,i);fd.file(`P${i}.jpg`,await(await fetch(da)).blob())}}}saveAs(await z.generateAsync({type:"blob"}),"Signed.zip");_sL(0)};async function _gR(d,n){const a=_ac.find(c=>c.fid==d.id&&c.pn==n);if(a)return{da:a.canvas.toDataURL({format:'jpeg',quality:0.8}),w:a.canvas.width,h:a.canvas.height};const tC=document.createElement('canvas'),fT=new fabric.Canvas(tC);let w,h;if(d.type==='application/pdf'){const p=await d.pdfDoc.getPage(n),v=p.getViewport({scale:2});w=v.width;h=v.height;tC.width=w;tC.height=h;await p.render({canvasContext:tC.getContext('2d'),viewport:v}).promise;await new Promise(r=>fabric.Image.fromURL(tC.toDataURL(),i=>{fT.setWidth(w);fT.setHeight(h);fT.setBackgroundImage(i,r)}))}else{const u=await _rF(d.file);await new Promise(r=>fabric.Image.fromURL(u,i=>{w=i.width;h=i.height;fT.setWidth(w);fT.setHeight(h);fT.setBackgroundImage(i,r)}))}if(_ms)await _aM(fT);const da=fT.toDataURL({format:'jpeg',quality:0.8});fT.dispose();return{da,w,h}}})()
</script>
</body>
</html>
